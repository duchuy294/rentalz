<!DOCTYPE html>
<html>
    <head>
        <title>CDrone</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
        <link rel="stylesheet" href="../lib/bootstrap/css/bootstrap.min.css">
        <link href="../lib/styles/mystyles.css" rel="stylesheet" type="text/css"/>
        <link href="../lib/fonts/fonts.css" rel="stylesheet" type="text/css"/>
        <script type="text/javascript" src="../lib/bootstrap/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="../js/jquery.3.1.1.min.js"></script>
		<script type="text/javascript" src="../js/socket.io-1.0.0.js"></script>
		<script type="text/javascript" src="../js/config.js"></script>
    </head>
    <body>
        <section id="cdronePage" class="full-page">
            <div class="page">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <strong><span class="glyphicon glyphicon-th"></span>&nbsp;&nbsp;CDrone</strong>
                    </div>
                    <div class="panel-body">  
                        <div class="container-fluid">
                            <form class="row form-horizontal">
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-4">CDrone name:</label>
                                    <div class="col-md-8 col-sm-7">
                                        <input id="cdrone_name" class="form-control" name="cdrone_name" type="text" value=""/><!--raspberrypi-->
                                    </div>
                                </div>    
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-4">Status:</label>
                                    <div class="col-md-8 col-sm-7">
                                        <input id="status" class="form-control" name="status" type="text" value="" disabled="true"/>
                                    </div>
                                </div>   
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-4">Commands:</label>
                                    <div class="col-md-8 col-sm-7">
                                        <input id="commands" class="form-control" name="commands" type="text" value="" disabled="true"/>
                                    </div>
                                </div>   
                            </form> 
                        </div>
                    </div>
                </div>              
            </div>
        </section>
    </body>

    <script>
        $(document).ready(function () {
            var socket = null,
				baseUrl = Config.host;
            function getCDroneInfo(val) {
                if (socket != null && val != "") {
                    console.log("Input cdrone name: ", val);
					console.log("socket 222222222", socket);
                    socket.emit("cdrone_info_app", {cDroneName: val});
                } else {
					$("#status").val("");
					$("#commands").val("");
				}
            }

            //Register enter event
            $("#cdrone_name").keydown(function (e) {
                var code = e.keyCode || e.which;
                if (code == 13) {
                    e.preventDefault();
                    //Send message get cdrone information
                    getCDroneInfo($(this).val());
                }
            });
            //Before close event
            $(window).bind("beforeunload", function (e) {
                if (socket != null) {
                    socket.close();
                }
            });
            //Initital
            function init()
            {
                socket = io(baseUrl + '/socket/cdrone');
                socket.io.on('connect_error', function (err) {
                    console.log('Error connecting to server');
                });
                socket.on('disconnect', function () {
                    console.log("disonnection");
                });
                socket.on("connect", function () {
                    console.log("connect")
                    //Send message to create a room
                    //this.emit("auth_initial", {clientid: "swadmin"});
					var logData = JSON.parse(localStorage.getItem("cdrone"));
					setCDroneDetail(logData);
					getCDroneInfo($("#cdrone_name").val());
                });
                //Receive authentication info
                socket.on("cdrone_info_app", function (data) {
                    console.log("App receive cdrone info", data);
                    if (data.Success === true) {
                        if (data != null) {
                            if (data.StatusName != undefined) {
                                $("#status").val(data.StatusName);
                            }
                            if (data.CommandName != undefined) {
                                $("#commands").val(data.CommandName);
                            }
                            var cdronename = $("#cdrone_name").val();
                            var cdronestatus = $("#status").val();
                            var cdronecommands = $("#commands").val();
                            localStorage.setItem("cdrone", JSON.stringify({cdrone_name: cdronename, status: cdronestatus, commands: cdronecommands}));
                        } else {
                            localStorage.setItem("cdrone", "");
                            //Command: Not found.
                        }
                    } else {
                        //Command: Error
                    }
                });
                
            }

            //Destroy
            function destroy()
            {
                if (socket != null) {
                    socket.close();
                }
            }
            init();
            //set CDrone Detail
            function setCDroneDetail(data) {
                for (var i in data) {
                    $("#" + i).val(data[i]);
                }
            }
        });
    </script>    
</html>